#################################################################
# âš¡ ×”×ª×¨××” ×¢×œ ×¦×¨×™×›×ª ×—×©××œ ×’×‘×•×”×” ×‘-Home Assistant
# ğŸš€ ×ª×™××•×¨: ×”×ª×¨××” ×¢× 5 ×”××›×©×™×¨×™× ×”×¦×•×¨×›×™× ×”×›×™ ×”×¨×‘×” ×—×©××œ ×›××©×¨
#          ×”×¦×¨×™×›×” ×”×›×•×œ×œ×ª ×—×•×¨×’×ª ××¡×£ ××¡×•×™×
#################################################################

# âœ… 1. ×™×¦×™×¨×ª ×—×™×™×©×Ÿ ×œ×¦×¨×™×›×ª ×—×©××œ ×›×•×œ×œ×ª
template:
  - sensor:
      - name: "×¦×¨×™×›×ª ×—×©××œ × ×•×›×—×™×ª"
        unit_of_measurement: 'W'
        state_class: measurement
        device_class: power
        state: >
          {{ (
            states('sensor.boiler_power')|float(0) +  
            states('sensor.ac_power')|float(0) +  
            states('sensor.fridge_power')|float(0) +  
            states('sensor.oven_power')|float(0) +  
            states('sensor.washing_machine_power')|float(0)  
          ) | round(0) }}

# âœ… 2. ××•×˜×•××¦×™×” ×œ×©×œ×™×—×ª ×”×ª×¨××” ×¢× 5 ×”×¦×¨×›× ×™× ×”×’×“×•×œ×™×
automation:
  - alias: "×”×ª×¨××” ×¢×œ ×¦×¨×™×›×ª ×—×©××œ ×’×‘×•×”×”"
    description: "×©×œ×™×—×ª ×”×•×“×¢×” ×¢× 5 ×”×¦×¨×›× ×™× ×”×’×“×•×œ×™× ×›××©×¨ ×”×¦×¨×™×›×” ×—×•×¨×’×ª ××¡×£"
    trigger:
      - platform: numeric_state
        entity_id: sensor.×¦×¨×™×›×ª_×—×©××œ_× ×•×›×—×™×ª
        above: 8000
    action:
      - service: notify.mobile_app_noy_iphone16_pro
        data:
          title: "âš ï¸ ×”×ª×¨××” ×¢×œ ×¦×¨×™×›×ª ×—×©××œ ×’×‘×•×”×”"
          message: >-
            {% set entities = [
              'sensor.boiler_power',
              'sensor.ac_power',
              'sensor.fridge_power',
              'sensor.oven_power',
              'sensor.washing_machine_power'
            ] %}

            {% set raw_data = namespace(items=[]) %}
            {% for entity_id in entities %}
              {% set state = states(entity_id) | float(default=-1) %}
              {% if state >= 0 %}
                {% set raw_data.items = raw_data.items + [{
                  'id': entity_id,
                  'name': state_attr(entity_id, 'friendly_name') | default(entity_id),
                  'value': state
                }] %}
              {% endif %}
            {% endfor %}

            {% set sorted_data = raw_data.items | sort(attribute='value', reverse=true) %}

            {% if sorted_data | count > 0 %}
              ğŸ† **5 ×”×¦×¨×›× ×™× ×”××•×‘×™×œ×™×:**
              {% for item in sorted_data[:5] %}
              ğŸ”¸ {{ item.name | replace("_", " ") | replace("×¦×¨×™×›×ª ×—×©××œ", "") | trim }}: {{ item.value | round(1) }}W
              {% endfor %}
            {% else %}
              âŒ **×œ× × ××¦××• × ×ª×•× ×™ ×¦×¨×™×›×”**
            {% endif %}
